# 排行榜系统说明文档

## 1. 系统架构

### 1.1 核心组件

- **Master**：排行榜管理器，负责注册和启动排行榜
- **Bucket**：排行榜桶，每个桶对应一个排行榜，包含周期切换、数据清理、分页遍历等逻辑
- **Statement**：排行榜周期状态管理，包含分数格式化逻辑
- **Handle**：排行榜处理接口，提供获取当前期数和过期时间的方法

### 1.2 数据存储

- **Redis ZSet**：存储排行榜数据，支持按分数排序
- **Redis Hash**：存储排行榜结算状态，字段为周期值，值为结算状态(0-未结算，1-已结算)

### 1.3 主要文件结构

| 文件名       | 主要功能                         | 关键方法/函数                                  |
|------------|------------------------------|-------------------------------------------|
| bucket.go  | 排行榜桶管理，包含周期切换、数据清理、分页遍历等逻辑     | start, Cycle, ZAdd, ZRank, ZPage, Range, changeCycle |
| module.go  | 排行榜系统初始化，设置 Redis 客户端、开服时间等      | Start, GetBucket, Register                |
| service.go | 排行榜对外接口（ZAdd, ZRank, ZPage 等）      | ZAdd, ZRank, ZPage, ZRange                |
| statement.go | 排行榜周期状态管理，包含分数格式化逻辑        | formatScore                               |
| master.go  | 排行榜管理器，注册和启动排行榜              | Register, start, heartbeat                |
| submit.go  | 排行榜结算逻辑                      | checkUnsettledRanks, maySubmit, changeCycle |

## 2. 核心功能

### 2.1 排行榜管理

- **注册排行榜**：通过 `Register` 函数注册排行榜，指定名称、最大数量、初始分数、排序类型和处理函数
- **获取排行榜**：通过 `GetBucket` 函数获取指定名称的排行榜

### 2.2 分数管理

- **设置分数**：通过 `ZAdd` 函数设置排行榜分数，使用最终值，而不是增量
- **获取分数**：通过 `ZRank` 函数获取个人名次，支持是否返回分数

### 2.3 周期管理

- **切换周期**：当当前周期结束时，自动切换到下一个周期
- **检查未结算周期**：在启动时检查 Redis hash 表中是否有未结算的排行榜

### 2.4 结算管理

- **结算排行榜**：当周期结束时，自动结算排行榜
- **删除结算记录**：结算完成后删除 hash 表中对应周期字段

### 2.5 分页管理

- **分页获取数据**：通过 `ZPage` 函数分页获取排行榜数据，支持自定义每页大小

## 3. 技术实现

### 3.1 分数格式化

- **降序排行榜**：分数 = 原始分数 + 剩余时间，确保相同分数的玩家按时间排序
- **升序排行榜**：分数 = 原始分数 + 已用时间，确保相同分数的玩家按时间排序
- **错误处理**：解析失败时返回原始分数，避免排行榜数据异常

### 3.2 并发安全

- **互斥锁保护**：在处理 `submits` 切片时使用互斥锁保护，确保并发操作的安全性
- **注意事项**：排行榜在程序启动时初始化，不需要使用竞态保护

### 3.3 错误处理

- **初始化错误**：正确返回 `Master.start()` 的错误，确保初始化失败时能够向上层报告
- **时间解析错误**：添加对 `time.Parse` 错误的捕获，避免初始化失败
- **分数格式化错误**：添加对 `strconv.ParseFloat` 错误的捕获，避免排行榜数据异常
- **Redis 操作错误**：捕获并处理 Redis 操作错误，确保系统的稳定性

### 3.4 分页逻辑

- **循环条件**：使用 `paging.Page <= paging.Total` 作为循环条件，确保分页遍历的正确性
- **分页计算**：通过 `(paging.Page - 1) * paging.Size` 计算起始位置，`s + paging.Size - 1` 计算结束位置

### 3.5 结算记录存储

- **存储方式**：使用 Redis hash 表存储结算状态，字段为周期值，值为结算状态(0-未结算，1-已结算)
- **删除策略**：结算完成后使用 `HDel` 删除 hash 表中对应周期字段，减少 Redis 键数量

### 3.6 时间单位一致性

- **Redis 过期时间**：使用 `7*24*time.Hour` 表示 7 天，与 Redis 的过期时间单位一致

## 4. 修复的问题

### 4.1 并发安全问题

- **问题**：在处理 `submits` 切片时没有使用互斥锁保护，可能导致并发修改切片的问题
- **修复**：在 `checkUnsettledRanks` 函数中添加互斥锁保护对 `this.submits` 切片的访问

### 4.2 错误处理问题

- **问题**：`Start` 函数忽略 `Master.start()` 返回错误，直接返回 nil
- **修复**：修改为正确返回 `Master.start()` 的错误，确保初始化失败时能够向上层报告

### 4.3 分页逻辑问题

- **问题**：`Range` 函数的循环条件使用 `i < paging.Total` 导致遍历不完整或无限循环
- **修复**：修改为使用 `paging.Page <= paging.Total` 作为循环条件，并在循环中递增 `paging.Page`

### 4.4 结算记录存储问题

- **问题**：每个周期使用独立 Redis key 存储结算状态，导致键数量过多
- **修复**：改为使用 Redis hash 表存储结算状态，字段为周期值，值为结算状态(0-未结算，1-已结算)

### 4.5 时间单位一致性问题

- **问题**：检查 Redis.Expire 过期时间和 time.Hour（纳秒）是否一致
- **验证**：`7*24*time.Hour` 表示 7 天，与 Redis 的过期时间单位一致

## 5. 使用方法

### 5.1 初始化

```go
import "github.com/hwcer/rank"

// 初始化排行榜系统
err := rank.Start(redisClient, "shareId", 1)
if err != nil {
    log.Fatalf("初始化排行榜失败: %v", err)
}
```

### 5.2 注册排行榜

```go
// 注册排行榜
rank.Register("daily", 100, 0, rank.SortTypeDesc, handle)
```

### 5.3 设置分数

```go
// 设置排行榜分数
err := rank.ZAdd("daily", cycle, "uid1", 100)
if err != nil {
    log.Errorf("设置排行榜分数失败: %v", err)
}
```

### 5.4 获取个人名次

```go
// 获取个人名次
player, err := rank.ZRank("daily", cycle, "uid1", true)
if err != nil {
    log.Errorf("获取个人名次失败: %v", err)
}
fmt.Printf("名次: %d, 分数: %f\n", player.Rank, player.Score)
```

### 5.5 分页获取数据

```go
// 分页获取排行榜数据
paging := &cosmo.Paging{Page: 1, Size: 10}
err := rank.ZPage("daily", cycle, paging)
if err != nil {
    log.Errorf("分页获取排行榜数据失败: %v", err)
}
```

## 6. 注意事项

### 6.1 并发安全

- 在多线程环境下，排行榜系统已经通过互斥锁保护了关键操作，确保并发安全

### 6.2 错误处理

- 系统已经完善了错误处理机制，避免了初始化失败、时间解析错误、分数格式化错误等导致的系统异常

### 6.3 性能优化

- 结算记录存储使用了 Redis hash 表，减少了 Redis 键数量，提高了查询效率
- 分页遍历逻辑已经修复，确保所有玩家数据都能被处理

### 6.4 时间单位

- Redis.Expire 过期时间使用了 `7*24*time.Hour` 表示 7 天，与 Redis 的过期时间单位一致

### 6.5 结算机制

- 切换周期时会将上一届状态写入 Redis hash 表，启动时会检查未结算的排行榜
- 结算完成后会删除 hash 表中对应周期字段，减少 Redis 键数量

## 7. 总结

排行榜系统是一个功能完整、性能优化、并发安全的系统，支持多种排行榜类型、周期管理、结算管理和分页管理。系统已经修复了并发安全、错误处理、分页逻辑、结算记录存储等问题，确保了系统的稳定性和可靠性。

通过本系统，开发者可以方便地实现各种排行榜功能，如日榜、周榜、月榜等，支持按分数排序、按时间排序等多种排序方式，满足不同游戏的需求。